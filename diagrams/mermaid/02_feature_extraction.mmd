flowchart TD
    subgraph "Input Processing"
        A[RGB Frame] --> B[Channel Separation]
        B --> C[Green Channel]
        C --> D["CLAHE Enhancement<br/>(clipLimit=2.0, tileGridSize=8x8)"]
    end

    subgraph "Vessel Segmentation"
        D --> E{U-Net Available?}
        E -->|Yes| F[Neural U-Net Segmentation]
        E -->|No| G[Frangi Vesselness Filter]
        F --> H[Binary Vessel Mask]
        G --> H
    end

    subgraph "Quality Metrics"
        D --> I[Laplacian Variance<br/>Sharpness Score]
        H --> J[Vessel Pixel Ratio<br/>Visibility Score]
        I --> K[Combined Quality Score]
        J --> K
    end

    subgraph "Reference Frame Selection"
        K --> L[Rank All Frames]
        L --> M[Select Highest Score]
        M --> N[Reference Frame]
    end

    style A fill:#e3f2fd
    style C fill:#c8e6c9
    style H fill:#fff9c4
    style N fill:#f3e5f5

    note1[Green channel provides<br/>2.5x better vessel contrast<br/>than grayscale]
    style note1 fill:#f5f5f5,stroke:#9e9e9e

